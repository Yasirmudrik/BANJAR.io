<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Absensi Sholat Dzuhur</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            greenest: {
              50: '#f0f9f4',
              100: '#d1e9d8',
              200: '#a3d3b1',
              300: '#75bd8a',
              400: '#47a964',
              500: '#2f8c46',
              600: '#246b36',
              700: '#1a4b25',
              800: '#113414',
              900: '#091a0a',
            },
            yellowest: {
              50: '#fff9eb',
              100: '#fff1c2',
              200: '#ffe799',
              300: '#ffdd70',
              400: '#ffd347',
              500: '#ffca1e',
              600: '#cca316',
              700: '#99790f',
              800: '#664f09',
              900: '#332704',
            },
            redest: {
              50: '#fef2f2',
              100: '#fbd5d5',
              200: '#f8b8b8',
              300: '#f59b9b',
              400: '#f27e7e',
              500: '#ef6161',
              600: '#c94e4e',
              700: '#9a3a3a',
              800: '#6b2727',
              900: '#3d1313',
            }
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    @media print {
      body * {
        visibility: hidden;
      }
      #printable, #printable * {
        visibility: visible;
      }
      #printable {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      #print-button {
        display: none !important;
      }
    }
  </style>
</head>
<body class="bg-greenest-50 min-h-screen flex flex-col text-greenest-900">
  <header class="bg-greenest-200 text-greenest-900 p-4 shadow-md">
    <h1 class="text-2xl font-semibold text-center">Absensi Sholat MTS Muhammadiyah Sigaluh</h1>
  </header>

  <main class="flex-grow container mx-auto p-4 max-w-7xl">
    <section class="mb-8 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
      <h2 class="text-xl font-semibold mb-4 md:mb-0 text-center md:text-left">Pilih Kelas</h2>
      <div class="flex flex-wrap justify-center gap-4 flex-grow">
        <button data-class="7a" class="class-btn px-4 py-2 rounded bg-greenest-300 text-greenest-900 hover:bg-greenest-400 transition">VIIA</button>
        <button data-class="7b" class="class-btn px-4 py-2 rounded bg-greenest-300 text-greenest-900 hover:bg-greenest-400 transition">VIIB</button>
        <button data-class="8a" class="class-btn px-4 py-2 rounded bg-greenest-300 text-greenest-900 hover:bg-greenest-400 transition">VIIIA</button>
        <button data-class="8b" class="class-btn px-4 py-2 rounded bg-greenest-300 text-greenest-900 hover:bg-greenest-400 transition">VIIIB</button>
        <button data-class="9a" class="class-btn px-4 py-2 rounded bg-greenest-300 text-greenest-900 hover:bg-greenest-400 transition">IXA</button>
        <button data-class="9b" class="class-btn px-4 py-2 rounded bg-greenest-300 text-greenest-900 hover:bg-greenest-400 transition">IXB</button>
      </div>
      <div class="flex gap-2 flex-wrap justify-center md:justify-start">
        <button id="btn-global-rekap" class="px-4 py-2 bg-greenest-400 text-greenest-900 rounded hover:bg-greenest-500 transition flex items-center gap-2 w-full sm:w-auto justify-center">
          <i class="fas fa-chart-bar"></i> Rekap Semua Kelas
        </button>
      </div>
    </section>

    <section id="class-section" class="hidden">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4 gap-2 md:gap-0">
        <h2 id="class-title" class="text-2xl font-semibold mb-2 md:mb-0"></h2>
        <div class="flex gap-2 flex-wrap items-center">
          <button id="btn-rekap" class="px-4 py-2 bg-greenest-400 text-greenest-900 rounded hover:bg-greenest-500 transition flex items-center gap-2">
            <i class="fas fa-chart-bar"></i> Rekap Absensi
          </button>
          <button id="btn-tambah" class="px-4 py-2 bg-greenest-300 text-greenest-900 rounded hover:bg-greenest-400 transition flex items-center gap-2">
            <i class="fas fa-plus"></i> Tambah Siswa
          </button>
          <button id="btn-hapus-siswa" class="px-4 py-2 bg-redest-700 text-white rounded hover:bg-redest-800 transition flex items-center gap-2">
            <i class="fas fa-user-minus"></i> Hapus Siswa
          </button>
          <span id="absen-status" class="ml-2 text-sm font-semibold text-redest-700 hidden">Absensi hari ini sudah selesai</span>
        </div>
      </div>

      <div id="student-list" class="overflow-x-auto border border-greenest-300 rounded bg-greenest-50 shadow-sm">
        <table class="min-w-full text-left text-greenest-900">
          <thead class="bg-greenest-100">
            <tr>
              <th class="px-4 py-2 border border-greenest-300">No</th>
              <th class="px-4 py-2 border border-greenest-300">Nama Siswa</th>
              <th class="px-4 py-2 border border-greenest-300">Hadir</th>
              <th class="px-4 py-2 border border-greenest-300">Sakit/Menstruasi</th>
              <th class="px-4 py-2 border border-greenest-300">Tidak Hadir</th>
              <th class="px-4 py-2 border border-greenest-300">Absensi</th>
            </tr>
          </thead>
          <tbody id="students-tbody"></tbody>
        </table>
      </div>

      <div class="mt-4 flex justify-center">
        <button id="btn-kirim" class="px-6 py-2 bg-greenest-600 text-greenest-50 rounded hover:bg-greenest-700 transition flex items-center gap-2">
          <i class="fas fa-paper-plane"></i> Kirim Hasil Absensi 
        </button>
      </div>
    </section>

    <section id="rekap-section" class="hidden max-w-5xl mx-auto mt-8">
      <h2 id="rekap-title" class="text-2xl font-semibold mb-4 text-center"></h2>
      <div class="flex flex-col sm:flex-row sm:justify-center sm:items-center sm:gap-4 mb-4 px-2">
        <label for="rekap-year" class="font-medium mb-1 sm:mb-0">Tahun:</label>
        <select id="rekap-year" class="border border-greenest-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-greenest-500">
        </select>
        <label for="rekap-month" class="font-medium mb-1 sm:mb-0">Bulan:</label>
        <select id="rekap-month" class="border border-greenest-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-greenest-500">
          <option value="01">Januari</option>
          <option value="02">Februari</option>
          <option value="03">Maret</option>
          <option value="04">April</option>
          <option value="05">Mei</option>
          <option value="06">Juni</option>
          <option value="07">Juli</option>
          <option value="08">Agustus</option>
          <option value="09">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>
      </div>
      <div id="printable" class="overflow-x-auto border border-greenest-300 rounded bg-greenest-50 shadow-sm">
        <table class="min-w-full text-left text-greenest-900" id="rekap-table">
          <thead class="bg-greenest-100">
            <tr>
              <th class="px-4 py-2 border border-greenest-300">No</th>
              <th class="px-4 py-2 border border-greenest-300">Nama Siswa</th>
              <th class="px-4 py-2 border border-greenest-300">Kelas</th>
              <th class="px-4 py-2 border border-greenest-300">Jumlah Hadir</th>
              <th class="px-4 py-2 border border-greenest-300">Jumlah Sakit</th>
              <th class="px-4 py-2 border border-greenest-300">Jumlah Tidak Hadir</th>
            </tr>
          </thead>
          <tbody id="rekap-tbody"></tbody>
        </table>
      </div>
      <div class="mt-4 flex justify-center gap-4 flex-wrap px-2">
        <button id="btn-back" class="px-4 py-2 bg-greenest-600 text-greenest-50 rounded hover:bg-greenest-700 transition flex items-center gap-2">
          <i class="fas fa-arrow-left"></i> Kembali
        </button>
        <button id="btn-rekap-refresh" class="px-4 py-2 bg-greenest-500 text-greenest-50 rounded hover:bg-greenest-600 transition flex items-center gap-2">
          <i class="fas fa-sync-alt"></i> Refresh Rekap
        </button>
        <button id="btn-print" class="px-4 py-2 bg-green-700 text-white rounded hover:bg-green-800 transition flex items-center gap-2">
          <i class="fas fa-print"></i> Print
        </button>
      </div>
    </section>

    <section id="tambah-section" class="hidden mt-8 max-w-md mx-auto bg-greenest-50 p-6 rounded shadow-sm border border-greenest-300">
      <h2 class="text-2xl font-semibold mb-4 text-center text-greenest-900">Tambah Siswa Baru</h2>
      <form id="form-tambah" class="flex flex-col gap-4">
        <div>
          <label for="nama-siswa" class="block mb-1 font-medium text-greenest-900">Nama Siswa</label>
          <input
            type="text"
            id="nama-siswa"
            name="nama-siswa"
            required
            class="w-full border border-greenest-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-greenest-500 text-greenest-900 bg-greenest-50"
            placeholder="Masukkan nama siswa"
          />
        </div>
        <div>
          <label for="kelas-siswa" class="block mb-1 font-medium text-greenest-900">Kelas</label>
          <select
            id="kelas-siswa"
            name="kelas-siswa"
            required
            class="w-full border border-greenest-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-greenest-500 text-greenest-900 bg-greenest-50"
          >
            <option value="" disabled selected>Pilih kelas</option>
            <option value="7a">VIIA</option>
            <option value="7b">VIIB</option>
            <option value="8a">VIIIA</option>
            <option value="8b">VIIIB</option>
            <option value="9a">IXA</option>
            <option value="9b">IXB</option>
          </select>
        </div>
        <div class="flex justify-center gap-4">
          <button
            type="submit"
            class="px-6 py-2 bg-greenest-300 text-greenest-900 rounded hover:bg-greenest-400 transition flex items-center gap-2"
          >
            <i class="fas fa-plus"></i> Tambah
          </button>
          <button
            type="button"
            id="btn-cancel-tambah"
            class="px-6 py-2 bg-greenest-600 text-greenest-50 rounded hover:bg-greenest-700 transition flex items-center gap-2"
          >
            <i class="fas fa-times"></i> Batal
          </button>
        </div>
      </form>
    </section>

    <section id="hapus-siswa-section" class="hidden mt-8 max-w-md mx-auto bg-greenest-50 p-6 rounded shadow-sm border border-greenest-300">
      <h2 class="text-2xl font-semibold mb-4 text-center text-greenest-900">Hapus Siswa</h2>
      <div class="mb-4">
        <label for="hapus-siswa-select" class="block mb-1 font-medium text-greenest-900">Pilih Siswa yang akan dihapus</label>
        <select id="hapus-siswa-select" class="w-full border border-greenest-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-redest-600 text-greenest-900 bg-greenest-50">
        </select>
      </div>
      <div class="flex justify-center gap-4">
        <button id="btn-confirm-hapus" class="px-6 py-2 bg-redest-700 text-white rounded hover:bg-redest-800 transition flex items-center gap-2">
          <i class="fas fa-trash-alt"></i> Hapus
        </button>
        <button id="btn-cancel-hapus" class="px-6 py-2 bg-greenest-600 text-greenest-50 rounded hover:bg-greenest-700 transition flex items-center gap-2">
          <i class="fas fa-times"></i> Batal
        </button>
      </div>
    </section>
  </main>

  <footer class="bg-greenest-200 text-greenest-900 text-center p-4 mt-auto">
    <p>MTS Muhammadiyah Sigaluh &copy; 2025</p>
  </footer>

  <script>
    // Data structure to hold students and their attendance counts
    // Initialize with 25 students per class with placeholder names
    const classes = ['7a', '7b', '8a', '8b', '9a', '9b'];
    const studentsData = {};
    // This will hold the "sent" attendance data for rekap display
    // Structure: sentAttendanceData[class][year][month] = array of students with attendance count for that month
    let sentAttendanceData = {};
    // Track attendance sent date per class (ISO date string)
    const attendanceSentDate = {};
    // Track which students have been marked present today per class (store student IDs)
    const attendanceMarkedToday = {};

    // Map class number to Roman numeral
    const romanMap = {
      '7': 'VII',
      '8': 'VIII',
      '9': 'IX'
    };

    // Convert class code like '7a' to 'VIIA'
    function classCodeToRoman(classCode) {
      const num = classCode.charAt(0);
      const letter = classCode.charAt(1).toUpperCase();
      return romanMap[num] + letter;
    }

    function generateStudentName(className, index) {
      return `Siswa ${classCodeToRoman(className)} ${index + 1}`;
    }

    classes.forEach((cls) => {
      studentsData[cls] = [];
      attendanceMarkedToday[cls] = new Set();
      sentAttendanceData[cls] = {};
      for (let i = 0; i < 25; i++) {
        studentsData[cls].push({
          id: crypto.randomUUID(),
          name: generateStudentName(cls, i),
          attendance: 0,
          sick: 0,
          statusToday: null, // 'absen' or 'sakit' or null
        });
      }
      attendanceSentDate[cls] = null; // no attendance sent yet
    });

    // DOM Elements
    const classButtons = document.querySelectorAll('.class-btn');
    const classSection = document.getElementById('class-section');
    const classTitle = document.getElementById('class-title');
    const studentsTbody = document.getElementById('students-tbody');
    const btnRekap = document.getElementById('btn-rekap');
    const btnTambah = document.getElementById('btn-tambah');
    const btnHapusSiswa = document.getElementById('btn-hapus-siswa');
    const rekapSection = document.getElementById('rekap-section');
    const rekapTbody = document.getElementById('rekap-tbody');
    const btnBack = document.getElementById('btn-back');
    const tambahSection = document.getElementById('tambah-section');
    const hapusSiswaSection = document.getElementById('hapus-siswa-section');
    const hapusSiswaSelect = document.getElementById('hapus-siswa-select');
    const btnConfirmHapus = document.getElementById('btn-confirm-hapus');
    const btnCancelHapus = document.getElementById('btn-cancel-hapus');
    const formTambah = document.getElementById('form-tambah');
    const btnCancelTambah = document.getElementById('btn-cancel-tambah');
    const namaSiswaInput = document.getElementById('nama-siswa');
    const kelasSiswaSelect = document.getElementById('kelas-siswa');
    const btnKirim = document.getElementById('btn-kirim');
    const btnGlobalRekap = document.getElementById('btn-global-rekap');
    const btnRekapRefresh = document.getElementById('btn-rekap-refresh');
    const absenStatus = document.getElementById('absen-status');
    const rekapTitle = document.getElementById('rekap-title');
    const rekapYearSelect = document.getElementById('rekap-year');
    const rekapMonthSelect = document.getElementById('rekap-month');
    const btnPrint = document.getElementById('btn-print');

    let currentClass = null;

    // Get today's date string in ISO format (yyyy-mm-dd)
    function getTodayDate() {
      const now = new Date();
      return now.toISOString().slice(0, 10);
    }

    // Get current year and month strings
    function getCurrentYearMonth() {
      const now = new Date();
      return {
        year: now.getFullYear().toString(),
        month: (now.getMonth() + 1).toString().padStart(2, '0')
      };
    }

    // Populate year select with a range of years from current year to 2040
    function populateYearSelect() {
      const currentYear = new Date().getFullYear();
      const endYear = 2040;
      rekapYearSelect.innerHTML = '';
      for (let y = currentYear; y <= endYear; y++) {
        const option = document.createElement('option');
        option.value = y.toString();
        option.textContent = y.toString();
        if (y === currentYear) option.selected = true;
        rekapYearSelect.appendChild(option);
      }
    }

    // Reset attendanceMarkedToday sets if date changed
    function resetAttendanceMarkedIfDateChanged() {
      const today = getTodayDate();
      classes.forEach(cls => {
        if (attendanceSentDate[cls] !== today) {
          attendanceMarkedToday[cls] = new Set();
          // Reset statusToday for all students in class
          studentsData[cls].forEach(s => s.statusToday = null);
        }
      });
    }

    // Check if attendance for currentClass is locked (sent today)
    function isAttendanceLocked(className) {
      return attendanceSentDate[className] === getTodayDate();
    }

    // Show students of selected class
    function showClass(className) {
      resetAttendanceMarkedIfDateChanged();
      currentClass = className;
      classTitle.textContent = `Kelas ${classCodeToRoman(className)}`;
      renderStudentList();
      updateAttendanceLockUI();
      classSection.classList.remove('hidden');
      rekapSection.classList.add('hidden');
      tambahSection.classList.add('hidden');
      hapusSiswaSection.classList.add('hidden');
    }

    // Update UI for attendance lock status and disable buttons if locked
    function updateAttendanceLockUI() {
      const locked = isAttendanceLocked(currentClass);
      if (locked) {
        absenStatus.classList.remove('hidden');
        btnKirim.disabled = true;
        btnKirim.classList.add('opacity-50', 'cursor-not-allowed');
        // Disable all buttons
        document.querySelectorAll('.btn-absen, .btn-sakit, .btn-hapus').forEach(btn => {
          btn.disabled = true;
          btn.classList.add('opacity-50', 'cursor-not-allowed');
          btn.title = "Absensi hari ini sudah selesai";
        });
        btnHapusSiswa.disabled = true;
        btnHapusSiswa.classList.add('opacity-50', 'cursor-not-allowed');
      } else {
        absenStatus.classList.add('hidden');
        btnKirim.disabled = false;
        btnKirim.classList.remove('opacity-50', 'cursor-not-allowed');
        // Enable all buttons
        document.querySelectorAll('.btn-absen, .btn-sakit, .btn-hapus').forEach(btn => {
          btn.disabled = false;
          btn.classList.remove('opacity-50', 'cursor-not-allowed');
          // Set title based on button type
          if (btn.classList.contains('btn-absen')) btn.title = "Tambah Absensi";
          else if (btn.classList.contains('btn-sakit')) btn.title = "Tambah Sakit";
          else if (btn.classList.contains('btn-hapus')) btn.title = "Hapus Siswa";
        });
        btnHapusSiswa.disabled = false;
        btnHapusSiswa.classList.remove('opacity-50', 'cursor-not-allowed');
      }
    }

    // Render student list table for current class
    function renderStudentList() {
      studentsTbody.innerHTML = '';
      const students = studentsData[currentClass];
      students.forEach((student, index) => {
        const status = student.statusToday; // null, 'absen', 'sakit'
        const tidakHadir = status === null ? 1 : 0;
        const tr = document.createElement('tr');
        tr.classList.add('border-b', 'hover:bg-greenest-100');
        tr.innerHTML = `
          <td class="px-4 py-2 border border-greenest-300 align-middle">${index + 1}</td>
          <td class="px-4 py-2 border border-greenest-300 align-middle">${student.name}</td>
          <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${student.attendance}</td>
          <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${student.sick}</td>
          <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${tidakHadir}</td>
          <td class="px-4 py-2 border border-greenest-300 align-middle text-center flex justify-center gap-2">
            <button data-id="${student.id}" class="btn-absen px-3 py-1 rounded transition ${status === 'absen' ? 'bg-greenest-700 text-greenest-50 cursor-not-allowed' : 'bg-greenest-500 text-greenest-50 hover:bg-greenest-600'}" title="${status === 'absen' ? 'Sudah absen hari ini' : 'Tambah Absensi'}" ${status === 'absen' ? 'disabled' : ''}>
              <i class="fas fa-check"></i>
            </button>
            <button data-id="${student.id}" class="btn-sakit px-3 py-1 rounded transition ${status === 'sakit' ? 'bg-yellowest-700 text-yellowest-50 cursor-not-allowed' : 'bg-yellowest-600 text-yellowest-50 hover:bg-yellowest-700'}" title="${status === 'sakit' ? 'Sudah sakit hari ini' : 'Tambah Sakit'}" ${status === 'sakit' ? 'disabled' : ''}>
              <i class="fas fa-bed"></i>
            </button>
            <button data-id="${student.id}" class="btn-hapus px-3 py-1 rounded bg-redest-700 text-white hover:bg-redest-800 transition" title="Hapus Siswa">
              <i class="fas fa-trash-alt"></i>
            </button>
          </td>
        `;
        studentsTbody.appendChild(tr);
      });

      // Attach event listeners for absen buttons
      document.querySelectorAll('.btn-absen').forEach((btn) => {
        btn.onclick = () => {
          if (isAttendanceLocked(currentClass)) {
            alert('Absensi hari ini sudah selesai dan tidak bisa diubah.');
            return;
          }
          const id = btn.getAttribute('data-id');
          const student = studentsData[currentClass].find((s) => s.id === id);
          if (!student) return;
          if (student.statusToday === 'absen') {
            alert('Siswa ini sudah melakukan absensi hari ini.');
            return;
          }
          if (student.statusToday === 'sakit') {
            if (student.sick > 0) student.sick--;
          }
          student.attendance++;
          student.statusToday = 'absen';
          renderStudentList();
          updateAttendanceLockUI();
        };
      });

      // Attach event listeners for sakit buttons
      document.querySelectorAll('.btn-sakit').forEach((btn) => {
        btn.onclick = () => {
          if (isAttendanceLocked(currentClass)) {
            alert('Absensi hari ini sudah selesai dan tidak bisa diubah.');
            return;
          }
          const id = btn.getAttribute('data-id');
          const student = studentsData[currentClass].find((s) => s.id === id);
          if (!student) return;
          if (student.statusToday === 'sakit') {
            alert('Siswa ini sudah menandai sakit hari ini.');
            return;
          }
          if (student.statusToday === 'absen') {
            if (student.attendance > 0) student.attendance--;
          }
          student.sick++;
          student.statusToday = 'sakit';
          renderStudentList();
          updateAttendanceLockUI();
        };
      });

      // Attach event listeners for hapus buttons
      document.querySelectorAll('.btn-hapus').forEach((btn) => {
        btn.onclick = () => {
          if (isAttendanceLocked(currentClass)) {
            alert('Absensi hari ini sudah selesai dan tidak bisa diubah.');
            return;
          }
          const id = btn.getAttribute('data-id');
          const studentIndex = studentsData[currentClass].findIndex(s => s.id === id);
          if (studentIndex !== -1) {
            const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus siswa "${studentsData[currentClass][studentIndex].name}" dari kelas ${classCodeToRoman(currentClass)}?`);
            if (confirmDelete) {
              studentsData[currentClass].splice(studentIndex, 1);
              renderStudentList();
              updateAttendanceLockUI();
            }
          }
        };
      });

      updateAttendanceLockUI();
    }

    // Populate hapus siswa select options
    function populateHapusSiswaSelect() {
      hapusSiswaSelect.innerHTML = '';
      if (!currentClass) return;
      const students = studentsData[currentClass];
      if (students.length === 0) {
        const option = document.createElement('option');
        option.textContent = 'Tidak ada siswa di kelas ini';
        option.disabled = true;
        hapusSiswaSelect.appendChild(option);
        return;
      }
      students.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = student.name;
        hapusSiswaSelect.appendChild(option);
      });
    }

    // Show rekap absensi for all students in all classes using sentAttendanceData
    // If className provided, show only that class's rekap (monthly)
    // If no className, show all classes rekap (yearly)
    function showRekap(className = null, year = null, month = null) {
      classSection.classList.add('hidden');
      tambahSection.classList.add('hidden');
      hapusSiswaSection.classList.add('hidden');
      rekapSection.classList.remove('hidden');

      rekapTbody.innerHTML = '';
      let no = 1;
      const hasData = Object.keys(sentAttendanceData).length > 0;
      if (!hasData) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="6" class="text-center py-4 text-greenest-600">Belum ada data absensi yang dikirim.</td>`;
        rekapTbody.appendChild(tr);
        rekapTitle.textContent = 'Rekap Absensi Siswa';
        return;
      }

      if (className && year && month) {
        // Monthly rekap for the class
        rekapTitle.textContent = `Rekap Absensi Bulanan Kelas ${classCodeToRoman(className)} - ${getMonthName(month)} ${year}`;
        const yearData = sentAttendanceData[className][year];
        if (!yearData || !yearData[month]) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="6" class="text-center py-4 text-greenest-600">Belum ada data absensi bulan ini untuk kelas ${classCodeToRoman(className)}.</td>`;
          rekapTbody.appendChild(tr);
          return;
        }
        const students = yearData[month];
        students.forEach((student) => {
          const hadir = student.attendance || 0;
          const sakit = student.sick || 0;
          const tidakHadir = student.tidakHadir || 0;

          const tr = document.createElement('tr');
          tr.classList.add('border-b', 'hover:bg-greenest-100');
          tr.innerHTML = `
            <td class="px-4 py-2 border border-greenest-300 align-middle">${no++}</td>
            <td class="px-4 py-2 border border-greenest-300 align-middle">${student.name}</td>
            <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${classCodeToRoman(className)}</td>
            <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${hadir}</td>
            <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${sakit}</td>
            <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${tidakHadir}</td>
          `;
          rekapTbody.appendChild(tr);
        });
      } else {
        // Yearly rekap for all classes
        if (!year) year = new Date().getFullYear().toString();
        rekapTitle.textContent = `Rekap Absensi Tahunan Semua Kelas - ${year}`;
        classes.forEach((cls) => {
          const yearData = sentAttendanceData[cls][year];
          if (!yearData) return;
          // Aggregate attendance, sick, tidakHadir per student for the year
          const studentMap = new Map();
          Object.values(yearData).forEach(monthData => {
            monthData.forEach(student => {
              if (!studentMap.has(student.id)) {
                studentMap.set(student.id, { name: student.name, attendance: 0, sick: 0, tidakHadir: 0 });
              }
              studentMap.get(student.id).attendance += student.attendance || 0;
              studentMap.get(student.id).sick += student.sick || 0;
              studentMap.get(student.id).tidakHadir += student.tidakHadir || 0;
            });
          });
          studentMap.forEach((student) => {
            const tr = document.createElement('tr');
            tr.classList.add('border-b', 'hover:bg-greenest-100');
            tr.innerHTML = `
              <td class="px-4 py-2 border border-greenest-300 align-middle">${no++}</td>
              <td class="px-4 py-2 border border-greenest-300 align-middle">${student.name}</td>
              <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${classCodeToRoman(cls)}</td>
              <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${student.attendance}</td>
              <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${student.sick}</td>
              <td class="px-4 py-2 border border-greenest-300 align-middle text-center">${student.tidakHadir}</td>
            `;
            rekapTbody.appendChild(tr);
          });
        });
        if (no === 1) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="6" class="text-center py-4 text-greenest-600">Belum ada data absensi tahunan yang dikirim.</td>`;
          rekapTbody.appendChild(tr);
        }
      }
    }

    // Helper to get month name in Indonesian from "01".."12"
    function getMonthName(month) {
      const months = {
        "01": "Januari",
        "02": "Februari",
        "03": "Maret",
        "04": "April",
        "05": "Mei",
        "06": "Juni",
        "07": "Juli",
        "08": "Agustus",
        "09": "September",
        "10": "Oktober",
        "11": "November",
        "12": "Desember"
      };
      return months[month] || month;
    }

    // Show tambah siswa form
    function showTambah() {
      classSection.classList.add('hidden');
      rekapSection.classList.add('hidden');
      hapusSiswaSection.classList.add('hidden');
      tambahSection.classList.remove('hidden');
      namaSiswaInput.value = '';
      kelasSiswaSelect.value = currentClass || '';
      kelasSiswaSelect.focus();
    }

    // Show hapus siswa form
    function showHapusSiswa() {
      if (!currentClass) {
        alert('Pilih kelas terlebih dahulu.');
        return;
      }
      classSection.classList.add('hidden');
      rekapSection.classList.add('hidden');
      tambahSection.classList.add('hidden');
      hapusSiswaSection.classList.remove('hidden');
      populateHapusSiswaSelect();
    }

    // Event Listeners
    classButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        showClass(btn.getAttribute('data-class'));
      });
    });

    btnRekap.addEventListener('click', () => {
      if (currentClass) {
        const { year, month } = getCurrentYearMonth();
        rekapYearSelect.value = year;
        rekapMonthSelect.value = month;
        showRekap(currentClass, year, month);
      }
    });

    btnGlobalRekap.addEventListener('click', () => {
      const currentYear = new Date().getFullYear().toString();
      rekapYearSelect.value = currentYear;
      rekapMonthSelect.value = '';
      showRekap(null, currentYear, null);
    });

    btnBack.addEventListener('click', () => {
      if (currentClass) {
        showClass(currentClass);
      } else {
        classSection.classList.add('hidden');
        rekapSection.classList.add('hidden');
        tambahSection.classList.add('hidden');
        hapusSiswaSection.classList.add('hidden');
      }
    });

    btnRekapRefresh.addEventListener('click', () => {
      const selectedYear = rekapYearSelect.value;
      const selectedMonth = rekapMonthSelect.value;
      if (currentClass) {
        if (selectedMonth) {
          showRekap(currentClass, selectedYear, selectedMonth);
        } else {
          showRekap(currentClass, selectedYear, null);
        }
      } else {
        showRekap(null, selectedYear, null);
      }
    });

    rekapYearSelect.addEventListener('change', () => {
      const selectedYear = rekapYearSelect.value;
      const selectedMonth = rekapMonthSelect.value;
      if (currentClass) {
        if (selectedMonth) {
          showRekap(currentClass, selectedYear, selectedMonth);
        } else {
          showRekap(currentClass, selectedYear, null);
        }
      } else {
        showRekap(null, selectedYear, null);
      }
    });

    rekapMonthSelect.addEventListener('change', () => {
      const selectedYear = rekapYearSelect.value;
      const selectedMonth = rekapMonthSelect.value;
      if (currentClass) {
        if (selectedMonth) {
          showRekap(currentClass, selectedYear, selectedMonth);
        } else {
          showRekap(currentClass, selectedYear, null);
        }
      } else {
        showRekap(null, selectedYear, null);
      }
    });

    btnTambah.addEventListener('click', () => {
      showTambah();
    });

    btnHapusSiswa.addEventListener('click', () => {
      showHapusSiswa();
    });

    btnCancelTambah.addEventListener('click', () => {
      if (currentClass) {
        showClass(currentClass);
      } else {
        tambahSection.classList.add('hidden');
      }
    });

    btnCancelHapus.addEventListener('click', () => {
      if (currentClass) {
        showClass(currentClass);
      } else {
        hapusSiswaSection.classList.add('hidden');
      }
    });

    btnConfirmHapus.addEventListener('click', () => {
      const selectedId = hapusSiswaSelect.value;
      if (!selectedId) {
        alert('Pilih siswa yang akan dihapus.');
        return;
      }
      const studentIndex = studentsData[currentClass].findIndex(s => s.id === selectedId);
      if (studentIndex === -1) {
        alert('Siswa tidak ditemukan.');
        return;
      }
      const confirmDelete = confirm(`Apakah Anda yakin ingin menghapus siswa "${studentsData[currentClass][studentIndex].name}" dari kelas ${classCodeToRoman(currentClass)}?`);
      if (confirmDelete) {
        studentsData[currentClass].splice(studentIndex, 1);
        alert('Siswa berhasil dihapus.');
        showClass(currentClass);
      }
    });

    formTambah.addEventListener('submit', (e) => {
      e.preventDefault();
      const nama = namaSiswaInput.value.trim();
      const kelas = kelasSiswaSelect.value;
      if (!nama || !kelas) {
        alert('Mohon isi nama dan pilih kelas siswa.');
        return;
      }
      if (!studentsData[kelas]) {
        studentsData[kelas] = [];
        attendanceMarkedToday[kelas] = new Set();
        sentAttendanceData[kelas] = {};
      }
      if (studentsData[kelas].length >= 100) {
        alert('Jumlah siswa maksimal 100 per kelas.');
        return;
      }
      studentsData[kelas].push({
        id: crypto.randomUUID(),
        name: nama,
        attendance: 0,
        sick: 0,
        statusToday: null,
      });
      alert(`Siswa "${nama}" berhasil ditambahkan ke kelas ${classCodeToRoman(kelas)}.`);
      if (kelas === currentClass) {
        renderStudentList();
        tambahSection.classList.add('hidden');
        classSection.classList.remove('hidden');
      } else {
        tambahSection.classList.add('hidden');
        currentClass = kelas;
        showClass(kelas);
      }
    });

    btnKirim.addEventListener('click', () => {
      if (!currentClass) {
        alert('Pilih kelas terlebih dahulu.');
        return;
      }
      if (isAttendanceLocked(currentClass)) {
        alert('Absensi hari ini sudah dikirim dan tidak bisa dikirim ulang.');
        return;
      }
      const { year, month } = getCurrentYearMonth();
      if (!sentAttendanceData[currentClass][year]) {
        sentAttendanceData[currentClass][year] = {};
      }
      if (!sentAttendanceData[currentClass][year][month]) {
        sentAttendanceData[currentClass][year][month] = [];
      }
      // Calculate tidakHadir for each student: if statusToday is null, count as 1 tidak hadir
      const attendanceSnapshot = studentsData[currentClass].map(s => ({
        id: s.id,
        name: s.name,
        attendance: s.attendance,
        sick: s.sick || 0,
        tidakHadir: s.statusToday === null ? 1 : 0,
      }));
      sentAttendanceData[currentClass][year][month] = attendanceSnapshot;
      attendanceSentDate[currentClass] = getTodayDate();
      // Clear statusToday for the class after sending
      studentsData[currentClass].forEach(s => s.statusToday = null);
      attendanceMarkedToday[currentClass] = new Set();
      alert(`Hasil absensi kelas ${classCodeToRoman(currentClass)} berhasil dikirim ke rekap.`);
      rekapYearSelect.value = year;
      rekapMonthSelect.value = month;
      showRekap(currentClass, year, month);
    });

    btnPrint.addEventListener('click', () => {
      window.print();
    });

    // Initialize year select and default view
    populateYearSelect();
  </script>
</body>
</html>